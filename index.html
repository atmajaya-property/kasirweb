<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Kasir Web</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
:root {
  --bg-1:#161616; --bg-2:#252525; --card:#2a2a2a;
  --muted:#8a8a8a; --accent:#14ffec; --accent-dark:#0d7377;
  --danger:#ff6b6b; --success:#4caf50; --warning:#ffa726;
}
*{box-sizing:border-box}
body{
  font-family:'Poppins',sans-serif;
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,var(--bg-1),var(--bg-2));
  color:#eee;
  overflow-x: hidden;
}
.page{display:none;opacity:0;transform:translateY(8px);transition:all .25s ease}
.page.active{display:block;opacity:1;transform:translateY(0)}

/* Login */
.login-card{
  max-width:360px;margin:12vh auto;background:var(--card);padding:26px;border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.5);text-align:center;border:1px solid rgba(255,255,255,.03)
}
.login-card h2{margin:0 0 12px;color:var(--accent)}
.login-card input{width:92%;padding:10px;margin:8px 0;border-radius:10px;border:none;background:#373737;color:#fff}
.login-card input:focus{box-shadow:0 0 6px rgba(20,255,236,.12)}
.login-card button{
  background:var(--accent-dark);
  border:none;
  padding:10px 20px;
  border-radius:10px;
  color:#fff;
  font-weight:700;
  cursor:pointer;
  margin-top:10px;
}
.login-card button:hover{background:var(--accent);color:#000}

/* HEADER & NAVIGATION */
header{
  display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:#111;border-bottom:1px solid rgba(255,255,255,.03);
  position:sticky;top:0;z-index:100;
}
header h1{margin:0;color:var(--accent);font-size:1.1rem}

.nav-tabs{
  display:flex;
  gap:2px;
  background:#1a1a1a;
  padding:4px;
  border-radius:8px;
  margin:0 8px;
  flex:1;
  max-width:400px;
}

.nav-tab{
  flex:1;
  padding:8px 12px;
  border:none;
  background:transparent;
  color:var(--muted);
  border-radius:6px;
  cursor:pointer;
  font-size:0.75rem;
  font-weight:600;
  transition:all 0.3s ease;
  white-space:nowrap;
}

.nav-tab.active{
  background:var(--accent-dark);
  color:#fff;
}

.nav-tab:hover:not(.active){
  background:rgba(255,255,255,0.05);
  color:#fff;
}

/* LAYOUT MOBILE */
.container{
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:8px;
  min-height:calc(100vh - 60px);
  overflow:visible;
}

/* Tab Content */
.tab-content {
  display: none;
  width: 100%;
}

.tab-content.active {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Menu section */
.menu-section{
  background:var(--card);
  border-radius:12px;
  padding:0;
  box-shadow:0 8px 20px rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.02);
  display:flex;
  flex-direction:column;
  height:auto;
  min-height:fit-content;
  position:relative;
  overflow:visible;
}

.menu-header{
  position:sticky;
  top:0;
  z-index:10;
  background:var(--card);
  border-radius:12px 12px 0 0;
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.05);
}

.menu-section h2{
  margin:0;
  color:var(--accent);
  text-align:center;
  font-size:1rem;
}

/* Search */
.search-wrap{
  display:flex;
  gap:6px;
  align-items:center;
  margin:8px 0 0 0;
  position:sticky;
  top:44px;
  z-index:9;
  background:var(--card);
  padding:5px 0;
}

.search-input{
  width:100%;
  background:#333;
  border-radius:8px;
  padding:8px 10px;
  border:1px solid rgba(255,255,255,.03);
  color:#fff;
  display:flex;
  align-items:center;
  gap:6px;
}
.search-input input{
  flex:1;
  border:none;
  background:transparent;
  color:inherit;
  outline:none;
  font-size:0.9rem;
}
.search-icon{color:var(--muted);margin-right:4px}

/* Menu list */
.menu-list-container{
  min-height:fit-content;
  padding:10px;
  overflow:visible;
  flex:1;
  height:auto;
}

.menu-list{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:3px;
  height:auto;
  max-height:none;
}

.menu-item{
  background:#3a3a3a;
  border:1px solid rgba(255,255,255,.04);
  color:#fff;
  padding:6px 3px;
  border-radius:6px;
  cursor:pointer;
  text-align:center;
  transition:all 0.2s ease;
  word-break:break-word;
  min-height:50px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  border:1px solid transparent;
  font-size:0.75rem;
}

.menu-item:hover, .menu-item:active{
  background:var(--accent);
  color:#000;
  transform:translateY(-1px);
  border-color:var(--accent);
}

.menu-item .nama{
  font-weight:600;
  margin-bottom:2px;
  line-height:1.1;
  font-size:0.7rem;
}

.menu-item .harga{
  font-size:0.65rem;
  color:var(--accent);
  font-weight:700;
  background:rgba(20,255,236,0.1);
  padding:1px 3px;
  border-radius:2px;
}

/* Pagination */
.menu-pagination{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 10px;
  border-top:1px solid rgba(255,255,255,.1);
  background:var(--card);
  position:sticky;
  bottom:0;
  z-index:8;
  border-radius:0 0 12px 12px;
}

.pagination-btn{
  background:#3a3a3a;
  border:1px solid rgba(255,255,255,.1);
  color:#fff;
  padding:5px 6px;
  border-radius:5px;
  cursor:pointer;
  font-size:0.7rem;
  min-width:60px;
}

.pagination-btn:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

.pagination-info{
  font-size:0.7rem;
  color:var(--muted);
  text-align:center;
  flex:1;
}

/* Transaksi section */
.transaksi-section{
  background:var(--card);
  border-radius:12px;
  padding:10px;
  box-shadow:0 8px 20px rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.02);
  min-height:fit-content;
  border:2px solid var(--accent-dark);
  display:flex;
  flex-direction:column;
  height:auto;
  min-height:400px;
}

.transaksi-section h2{
  margin:0 0 8px 0;
  color:var(--accent);
  text-align:center;
  font-size:1rem;
}

.transaksi-content{
  min-height:fit-content;
  background:rgba(255,255,255,0.02);
  border-radius:6px;
  padding:6px;
  margin-bottom:8px;
  overflow:visible;
  flex:1;
}

#tblTransaksi{
  width:100%;
  border-collapse:collapse;
  color:#ddd;
  font-size:0.8rem;
}
#tblTransaksi th,#tblTransaksi td{
  padding:5px 3px;
  border-bottom:1px solid rgba(255,255,255,.05);
  text-align:left;
}
#tblTransaksi th{
  color:var(--accent);
  font-weight:600;
  font-size:0.75rem;
  background:rgba(20,255,236,0.1);
}
#tblTransaksi th:last-child,#tblTransaksi td:last-child{
  text-align:right;
}
#tblTransaksi input.jumlah-input{
  width:35px;
  padding:2px;
  border-radius:3px;
  border:1px solid rgba(255,255,255,.1);
  background:#333;
  color:#fff;
  text-align:center;
  font-size:0.75rem;
  font-weight:600;
}

/* Total area */
.total-area{
  text-align:center;
  margin:8px 0 6px 0;
  font-weight:700;
  font-size:0.9rem;
  padding:8px;
  background:var(--accent-dark);
  border-radius:6px;
  color:#fff;
  border:1px solid var(--accent);
}

/* Input Area dengan layout konsisten */
.input-area{
  display: flex;
  gap: 8px;
  align-items: stretch;
  justify-content: space-between;
  margin: 10px 0;
  flex-wrap: wrap;
}

.cash-display, .kembali-display {
  flex: 1;
  min-width: 140px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.cash-display label, .kembali-display label {
  font-size: 0.75rem;
  color: var(--muted);
  font-weight: 600;
  text-align: center;
}

.cash-amount, .kembali-amount {
  background: rgba(20, 255, 236, 0.1);
  border: 1px solid var(--accent);
  border-radius: 6px;
  padding: 8px 10px;
  color: var(--accent);
  font-weight: 700;
  font-size: 0.85rem;
  text-align: right;
  min-height: 36px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  overflow: hidden;
}

.cash-amount {
  background: rgba(0, 230, 118, 0.1);
  border-color: #00e676;
  color: #00e676;
}

#cashInput {
  width: 100%;
  background: transparent;
  border: none;
  color: inherit;
  font: inherit;
  text-align: right;
  outline: none;
  min-width: 0;
  flex: 1;
}

.selesai{
  width:100%;
  margin-top:6px;
  padding:8px;
  border-radius:6px;
  background:var(--accent);
  color:#000;
  font-weight:700;
  cursor:pointer;
  border:none;
  font-size:0.85rem;
  transition:all 0.2s ease;
}
.selesai:hover{
  background:#00e676;
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(20,255,236,0.3);
}

.hapus-btn{
  background:var(--danger);
  color:#fff;
  border:none;
  border-radius:2px;
  padding:2px 4px;
  cursor:pointer;
  transition:.15s;
  font-size:0.65rem;
}
.hapus-btn:hover{
  background:#e53935;
}

/* Loading */
#menuLoading{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  color:var(--muted);
  font-size:.75rem;
  margin-top:8px;
  height:60px;
}
.spinner{
  width:10px;
  height:10px;
  border-radius:50%;
  border:2px solid rgba(20,255,236,.12);
  border-top-color:var(--accent);
  animation:spin .9s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ==================== */
/* TAB LAPORAN STYLES */
/* ==================== */
.laporan-section {
  background: var(--card);
  border-radius: 12px;
  padding: 15px;
  margin: 8px;
  box-shadow: 0 8px 20px rgba(0,0,0,.35);
  border: 1px solid rgba(255,255,255,.02);
}

.laporan-filter {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  flex-wrap: wrap;
  align-items: end;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
  min-width: 120px;
}

.filter-group label {
  font-size: 0.75rem;
  color: var(--muted);
  font-weight: 600;
}

.laporan-actions {
  display: flex;
  gap: 8px;
  margin: 15px 0;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.8rem;
  transition: all 0.2s ease;
}

.btn-primary {
  background: var(--accent-dark);
  color: white;
}

.btn-primary:hover {
  background: var(--accent);
  color: #000;
}

.btn-secondary {
  background: #444;
  color: white;
}

.btn-secondary:hover {
  background: #555;
}

.laporan-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.summary-card {
  background: rgba(255,255,255,0.05);
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  border-left: 4px solid var(--accent);
}

.summary-card h3 {
  margin: 0 0 5px 0;
  font-size: 0.8rem;
  color: var(--muted);
}

.summary-card .value {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--accent);
}

.laporan-table-container {
  overflow-x: auto;
  margin-top: 15px;
}

.laporan-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
}

.laporan-table th,
.laporan-table td {
  padding: 8px;
  text-align: left;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.laporan-table th {
  background: rgba(20,255,236,0.1);
  color: var(--accent);
  font-weight: 600;
  position: sticky;
  top: 0;
}

.laporan-table tr:hover {
  background: rgba(255,255,255,0.05);
}

/* ==================== */
/* TAB SETTING STYLES */
/* ==================== */
.setting-section {
  background: var(--card);
  border-radius: 12px;
  padding: 15px;
  margin: 8px;
  box-shadow: 0 8px 20px rgba(0,0,0,.35);
  border: 1px solid rgba(255,255,255,.02);
}

.setting-group {
  margin-bottom: 20px;
}

.setting-group h3 {
  color: var(--accent);
  margin-bottom: 10px;
  font-size: 1rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 5px;
}

.setting-item {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 10px;
  padding: 8px;
  background: rgba(255,255,255,0.02);
  border-radius: 6px;
}

.setting-label {
  flex: 1;
  font-size: 0.85rem;
  color: #fff;
}

.setting-control {
  flex: 1;
  display: flex;
  gap: 8px;
}

.color-preview {
  width: 30px;
  height: 30px;
  border-radius: 4px;
  border: 2px solid rgba(255,255,255,0.2);
}

/* Desktop layout */
@media (min-width: 768px) {
  .container{
    flex-direction:row;
    padding:12px;
    gap:12px;
    min-height:auto;
    height:calc(100vh - 60px);
  }
  
  .menu-section{
    flex:0 0 280px;
    height:auto;
    overflow-y:auto;
  }
  
  .transaksi-section, .laporan-section, .setting-section {
    flex:1;
    height:auto;
    min-height:auto;
  }
  
  .menu-list{
    grid-template-columns:1fr 1fr;
    gap:4px;
  }
  
  .menu-item{
    padding:8px 4px;
    min-height:55px;
    font-size:0.8rem;
  }
  
  .input-area {
    flex-direction: row;
    align-items: center;
  }
  
  .cash-display, .kembali-display {
    min-width: 160px;
  }
}

/* STRUK SEDERHANA */
.struk-container {
  display: none;
}

@media print {
  body * {
    visibility: hidden !important;
  }
  
  .struk-container,
  .struk-container * {
    visibility: visible !important;
    display: block !important;
  }
  
  .struk-container {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 80mm !important;
    min-height: 100mm !important;
    margin: 0 !important;
    padding: 3mm !important;
    background: white !important;
    color: black !important;
    font-family: 'Courier New', monospace !important;
    font-size: 12px !important;
    line-height: 1 !important;
  }
  
  .struk-header {
    text-align: center !important;
    margin-bottom: 2mm !important;
    border-bottom: 1px dashed #000 !important;
    padding-bottom: 1mm !important;
  }
  
  .struk-header h2 {
    font-size: 14px !important;
    font-weight: bold !important;
    margin: 0 !important;
  }
  
  .struk-tanggal {
    text-align: center !important;
    font-size: 10px !important;
    margin-bottom: 2mm !important;
  }
  
  .struk-table {
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 2mm 0 !important;
    font-size: 11px !important;
  }
  
  .struk-table th,
  .struk-table td {
    padding: 0.5mm 0 !important;
    text-align: left !important;
  }
  
  .struk-table th:nth-child(2),
  .struk-table td:nth-child(2),
  .struk-table th:nth-child(3),
  .struk-table td:nth-child(3) {
    text-align: right !important;
  }
  
  .struk-table tfoot {
    border-top: 1px dashed #000 !important;
    margin-top: 2mm !important;
  }
  
  .struk-table tfoot td {
    padding-top: 1mm !important;
    font-weight: bold !important;
  }
  
  .struk-footer {
    text-align: center !important;
    margin-top: 3mm !important;
    padding-top: 1mm !important;
    border-top: 1px dashed #000 !important;
    font-size: 10px !important;
  }
  
  @page {
    size: 80mm auto;
    margin: 0mm;
  }
}
  </style>
</head>
<body>

<!-- STRUK SEDERHANA -->
<div class="struk-container" id="strukContainer">
  <div class="struk-header">
    <h2 id="strukStoreName">TOKO KITA</h2>
  </div>
  <div class="struk-tanggal" id="strukDate"></div>
  <table class="struk-table">
    <thead>
      <tr>
        <th>Item</th>
        <th>Harga</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="strukItems"></tbody>
    <tfoot id="strukTotals"></tfoot>
  </table>
  <div class="struk-footer">
    Terima Kasih
  </div>
</div>

<!-- LOGIN PAGE -->
<div id="loginPage" class="page active">
  <div class="login-card">
    <h2>Login Kasir</h2>
    <input id="username" type="text" placeholder="Username" />
    <input id="password" type="password" placeholder="Password" />
    <button id="loginBtn">Masuk</button>
    <p id="loginMessage" style="color:#ff9b9b;min-height:1.2em;margin-top:8px"></p>
  </div>
</div>

<!-- KASIR PAGE -->
<div id="kasirPage" class="page">
  <header>
    <h1 id="namaToko"></h1>
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="kasir">üíº Kasir</button>
      <button class="nav-tab" data-tab="laporan">üìä Laporan</button>
      <button class="nav-tab" data-tab="setting">‚öôÔ∏è Setting</button>
    </div>
    <button id="logoutBtn">Keluar</button>
  </header>

  <!-- TAB KASIR -->
  <div class="tab-content active" data-tab="kasir">
    <div class="container">
      <section class="menu-section">
        <div class="menu-header">
          <h2>üìã Menu</h2>
          <div class="search-wrap">
            <div class="search-input">
              <span class="search-icon">üîç</span>
              <input id="menuSearch" type="search" placeholder="Cari menu..." aria-label="Cari menu" />
              <button id="clearSearch" title="Bersihkan pencarian" style="background:transparent;border:none;color:var(--muted);cursor:pointer">‚úñ</button>
            </div>
          </div>
        </div>

        <div class="menu-list-container">
          <div id="menuList" class="menu-list"></div>
          <div id="menuLoading" style="display:none">
            <div class="spinner"></div><div>Memuat menu...</div>
          </div>
        </div>

        <div class="menu-pagination">
          <button class="pagination-btn" id="prevPage">‚è™ Prev</button>
          <span class="pagination-info" id="pageInfo">Hal 1</span>
          <button class="pagination-btn" id="nextPage">Next ‚è©</button>
        </div>
      </section>

      <section class="transaksi-section">
        <h2>üí∞ Transaksi</h2>
        
        <div class="transaksi-content">
          <table id="tblTransaksi">
            <thead>
              <tr>
                <th>Menu</th>
                <th>Harga</th>
                <th>Jml</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="total-area">
          TOTAL: Rp <span id="totalHarga">0</span>
        </div>

        <div class="input-area">
          <div class="cash-display">
            <label>üíµ Bayar:</label>
            <div class="cash-amount">
              <span>Rp</span>
              <input id="cashInput" type="text" placeholder="0" value="0" />
            </div>
          </div>
          <div class="kembali-display">
            <label>üí∞ Kembali:</label>
            <div class="kembali-amount">Rp <span id="uangKembali">0</span></div>
          </div>
        </div>

        <button id="btnSelesai" class="selesai">
          üñ®Ô∏è Selesai & Cetak
        </button>
      </section>
    </div>
  </div>

  <!-- TAB LAPORAN -->
  <div class="tab-content" data-tab="laporan">
    <section class="laporan-section">
      <h2>üìä Laporan Transaksi</h2>
      
      <div class="laporan-filter">
        <div class="filter-group">
          <label>Dari Tanggal:</label>
          <input type="date" id="startDate">
        </div>
        <div class="filter-group">
          <label>Sampai Tanggal:</label>
          <input type="date" id="endDate">
        </div>
        <div class="filter-group">
          <label>Kasir:</label>
          <select id="filterKasir">
            <option value="">Semua Kasir</option>
          </select>
        </div>
      </div>

      <div class="laporan-actions">
        <button class="btn btn-primary" id="btnLoadLaporan">üì• Muat Laporan</button>
        <button class="btn btn-secondary" id="btnResetFilter">üîÑ Reset</button>
        <button class="btn btn-primary" id="btnExportLaporan">üì§ Export PDF</button>
      </div>

      <div class="laporan-summary" id="laporanSummary">
        <!-- Summary akan diisi oleh JavaScript -->
      </div>

      <div class="laporan-table-container">
        <table class="laporan-table" id="tblLaporan">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>ID Transaksi</th>
              <th>Kasir</th>
              <th>Total</th>
              <th>Bayar</th>
              <th>Kembali</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="laporanBody">
            <!-- Data laporan akan diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- TAB SETTING -->
  <div class="tab-content" data-tab="setting">
    <section class="setting-section">
      <h2>‚öôÔ∏è Pengaturan Aplikasi</h2>
      
      <div class="setting-group">
        <h3>üé® Tampilan</h3>
        
        <div class="setting-item">
          <div class="setting-label">Theme</div>
          <div class="setting-control">
            <select id="settingTheme">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="auto">Auto</option>
            </select>
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-label">Warna Aksen</div>
          <div class="setting-control">
            <input type="color" id="settingAccentColor" value="#14ffec">
            <div class="color-preview" id="accentPreview" style="background:#14ffec"></div>
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-label">Warna Aksen Dark</div>
          <div class="setting-control">
            <input type="color" id="settingAccentDark" value="#0d7377">
            <div class="color-preview" id="accentDarkPreview" style="background:#0d7377"></div>
          </div>
        </div>
      </div>

      <div class="setting-group">
        <h3>üì± Aplikasi</h3>
        
        <div class="setting-item">
          <div class="setting-label">Nama Aplikasi</div>
          <div class="setting-control">
            <input type="text" id="settingAppName" value="KASIR WEB" placeholder="Nama aplikasi">
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-label">Footer Struk</div>
          <div class="setting-control">
            <input type="text" id="settingStrukFooter" value="Terima Kasih" placeholder="Pesan footer struk">
          </div>
        </div>
      </div>

      <div class="laporan-actions">
        <button class="btn btn-primary" id="btnSaveSetting">üíæ Simpan Setting</button>
        <button class="btn btn-secondary" id="btnResetSetting">üîÑ Reset Default</button>
      </div>
    </section>
  </div>
</div>

<script>
  // KONFIGURASI
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrM2zFCnabXr6wgRHFJY7PPqUGJxTidsy26mH-oQKUEq7CWYLNHc_Xpkha7yw6bY4Q/exec";
  const ITEMS_PER_PAGE = 20;
  
  let kasirInfo = {};
  let transaksi = [];
  let menuData = [];
  let currentPage = 1;
  let filteredMenu = [];
  let currentSettings = {};
  let laporanData = [];

  // Helper functions
  function formatRupiah(angka){
    const n = parseInt(angka) || 0;
    return n.toLocaleString('id-ID');
  }
  
  function parseNumberFromString(s){
    if (!s) return 0;
    return parseInt((s + '').replace(/[^\d]/g, '')) || 0;
  }

  function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
  }

  // Navigation between tabs
  function setupTabNavigation() {
    const tabs = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show target content, hide others
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.dataset.tab === targetTab) {
            content.classList.add('active');
          }
        });
        
        // Load data if needed
        if (targetTab === 'laporan') {
          loadLaporan();
        } else if (targetTab === 'setting') {
          loadSetting();
        }
      });
    });
  }

  // Render menu dengan pagination
  function renderMenuList(items = filteredMenu){
    const list = document.getElementById('menuList');
    list.innerHTML = '';
    
    if (!items || items.length === 0) {
      list.innerHTML = "<div style='color:var(--muted); text-align:center; padding:10px; grid-column:1/-1; font-size:0.7rem;'>Tidak ada menu</div>";
      updatePaginationInfo(0);
      return;
    }

    const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const itemsToShow = items.slice(startIndex, endIndex);

    itemsToShow.forEach(m => {
      const btn = document.createElement('button');
      const hargaNum = (typeof m.harga === 'string') ? parseNumberFromString(m.harga) : (m.harga || 0);
      
      btn.className = 'menu-item';
      btn.innerHTML = `
        <div class="nama">${m.nama}</div>
        <div class="harga">Rp${formatRupiah(hargaNum)}</div>
      `;
      btn.onclick = () => tambahMenu({ 
        id: m.id,
        nama: m.nama, 
        harga: hargaNum 
      });
      list.appendChild(btn);
    });

    updatePaginationInfo(items.length, totalPages);
  }

  function updatePaginationInfo(totalItems, totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE)) {
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    pageInfo.textContent = `Hal ${currentPage}/${totalPages}`;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages || totalPages === 0;
  }

  function goToPage(page) {
    currentPage = page;
    renderMenuList();
  }

  // Load menu dari server
  async function loadMenu(){
    const spinner = document.getElementById('menuLoading');
    if (spinner) spinner.style.display = 'flex';
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getMenu', idToko: kasirInfo.idToko })
      });
      const data = await res.json();
      
      if (data && data.success && Array.isArray(data.data)) {
        menuData = data.data.map((m, index) => {
          const idFromServer = m.id || m.ID || m.Id || m.kode || m.Kode || m.kode_menu || m.id_menu || `M${String(index + 1).padStart(3, '0')}`;
          const hargaFromServer = typeof m.harga === 'string' ? parseNumberFromString(m.harga) : (m.harga || 0);
          
          return {
            id: idFromServer,
            nama: m.nama || m.Nama || 'Menu tanpa nama',
            kategori: (m.kategori || m.Kategori || '').toString(),
            harga: hargaFromServer
          };
        });
        
        filteredMenu = [...menuData];
        currentPage = 1;
        renderMenuList();
      } else {
        menuData = [];
        filteredMenu = [];
        renderMenuList([]);
      }
    } catch(err) {
      menuData = [];
      filteredMenu = [];
      renderMenuList([]);
    } finally {
      if (spinner) spinner.style.display = 'none';
    }
  }

  // Filter pencarian
  function filterMenuByText(text){
    if (!text) {
      filteredMenu = [...menuData];
      currentPage = 1;
      renderMenuList();
      return;
    }
    
    const q = text.trim().toLowerCase();
    filteredMenu = menuData.filter(m => {
      return (m.nama && m.nama.toLowerCase().includes(q)) || 
             (m.kategori && m.kategori.toLowerCase().includes(q));
    });
    
    currentPage = 1;
    renderMenuList();
  }

 // PERBAIKAN: Tambah menu dengan fokus yang benar
function tambahMenu(menu){
  const existingIndex = transaksi.findIndex(t => t.id === menu.id);
  
  if (existingIndex !== -1) {
    transaksi[existingIndex].jumlah = (transaksi[existingIndex].jumlah || 0) + 1;
    transaksi[existingIndex].subtotal = transaksi[existingIndex].jumlah * transaksi[existingIndex].harga;
  } else {
    transaksi.push({ 
      id: menu.id,
      nama: menu.nama, 
      harga: menu.harga,
      jumlah: 1, 
      subtotal: menu.harga 
    });
  }
  
  renderTransaksi();
  
  // Fokus ke input jumlah setelah render
  setTimeout(() => {
    const inputs = document.querySelectorAll(".jumlah-input");
    const targetIndex = existingIndex !== -1 ? existingIndex : inputs.length - 1;
    
    if (inputs[targetIndex]) {
      inputs[targetIndex].focus();
      inputs[targetIndex].select();
    }
  }, 100);
}

// PERBAIKAN: Render transaksi dengan event listeners yang benar
function renderTransaksi(){
  const tbody = document.querySelector('#tblTransaksi tbody');
  tbody.innerHTML = '';
  let total = 0;
  
  transaksi.forEach((item, i) => {
    total += item.subtotal;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${item.nama}</strong></td>
      <td>Rp${formatRupiah(item.harga)}</td>
      <td><input type="number" min="1" value="${item.jumlah}" data-index="${i}" class="jumlah-input"></td>
      <td><strong>Rp${formatRupiah(item.subtotal)}</strong></td>
      <td><button class="hapus-btn" data-index="${i}" title="Hapus item">‚ùå</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('totalHarga').textContent = formatRupiah(total);

  // Event handlers
  document.querySelectorAll('.hapus-btn').forEach(btn => {
    btn.onclick = (ev) => {
      const idx = parseInt(ev.currentTarget.dataset.index);
      transaksi.splice(idx, 1);
      renderTransaksi();
    };
  });

  // PERBAIKAN: Event listeners untuk input jumlah
  document.querySelectorAll('.jumlah-input').forEach(inp => {
    inp.oninput = function(e) {
      const i = parseInt(e.target.dataset.index);
      let newJumlah = parseInt(e.target.value) || 0;
      if (newJumlah < 1) {
        transaksi.splice(i, 1);
      } else {
        transaksi[i].jumlah = newJumlah;
        transaksi[i].subtotal = transaksi[i].jumlah * transaksi[i].harga;
      }
      renderTransaksi();
    };
    
    inp.onfocus = function(e) {
      e.target.select();
    };
    
    // PERBAIKAN: Enter key untuk pindah ke cash input
    inp.onkeydown = function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('cashInput').focus();
      }
    };
  });

  hitungKembali();

}  

// PERBAIKAN: Hitung kembalian dengan auto-update
// GANTI fungsi hitungKembali dengan ini:
function hitungKembali() {
  const cashInput = document.getElementById('cashInput');
  const bayar = parseNumberFromString(cashInput.value);
  const total = transaksi.reduce((s, it) => s + it.subtotal, 0);
  const kembali = bayar - total;
  
  document.getElementById('uangKembali').textContent = formatRupiah(kembali > 0 ? kembali : 0);
}

// GANTI event listener cashInput dengan ini:
document.getElementById('cashInput').addEventListener('input', function(e) {
  // Biarkan user input bebas, jangan auto-format dulu
  hitungKembali();
});

document.getElementById('cashInput').addEventListener('blur', function(e) {
  // Format hanya ketika kehilangan fokus
  let digits = (e.target.value + '').replace(/[^\d]/g, '');
  if (digits === '') {
    e.target.value = '';
  } else {
    e.target.value = formatRupiah(digits);
  }
  hitungKembali();
});
document.getElementById('cashInput').addEventListener('focus', function(e) {
  e.target.select();
});

// PERBAIKAN: Enter key di cash input untuk selesai transaksi
document.getElementById('cashInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('btnSelesai').click();
  }
});

  // PRINT STRUK
  function printStruk() {
    const total = transaksi.reduce((s, it) => s + it.subtotal, 0);
    const bayar = parseNumberFromString(document.getElementById('cashInput').value);
    const kembali = bayar - total;
    
    document.getElementById('strukStoreName').textContent = kasirInfo.namaToko || 'TOKO KITA';
    document.getElementById('strukDate').textContent = new Date().toLocaleString('id-ID');
    
    const strukItems = document.getElementById('strukItems');
    strukItems.innerHTML = '';
    transaksi.forEach(item => {
      const tr = document.createElement('tr');
      const nama = item.nama.length > 20 ? item.nama.substring(0, 20) + '...' : item.nama;
      tr.innerHTML = `
        <td>${nama} (${item.jumlah})</td>
        <td>${formatRupiah(item.harga)}</td>
        <td>${formatRupiah(item.subtotal)}</td>
      `;
      strukItems.appendChild(tr);
    });
    
    const strukTotals = document.getElementById('strukTotals');
    strukTotals.innerHTML = `
      <tr>
        <td colspan="2">Total</td>
        <td>${formatRupiah(total)}</td>
      </tr>
      <tr>
        <td colspan="2">Bayar</td>
        <td>${formatRupiah(bayar)}</td>
      </tr>
      <tr>
        <td colspan="2">Kembali</td>
        <td>${formatRupiah(kembali)}</td>
      </tr>
    `;
    
    document.getElementById('strukContainer').style.display = 'block';
    
    setTimeout(() => {
      window.print();
      setTimeout(() => {
        document.getElementById('strukContainer').style.display = 'none';
      }, 100);
    }, 500);
  }

 // PERBAIKAN: Load laporan dengan error handling
// Di fungsi loadLaporan, tambahkan console.log:
async function loadLaporan() {
  try {
    console.log("Loading laporan...");
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    console.log("Params:", { startDate, endDate, idToko: kasirInfo.idToko });
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ 
        action: 'getLaporan',
        startDate: startDate,
        endDate: endDate,
        idToko: kasirInfo.idToko
      })
    });
    
    const data = await res.json();
    console.log("Laporan response:", data);
    
    if (data && data.success) {
      laporanData = data.data || [];
      console.log("Laporan data received:", laporanData);
      renderLaporan(laporanData, data.summary);
    } else {
      alert('Gagal memuat laporan: ' + (data.message || 'Unknown error'));
    }
  } catch (err) {
    console.error('Error loadLaporan:', err);
    alert('Gagal memuat laporan: ' + err.message);
  }
}
// PERBAIKAN: Render laporan dengan handling data yang aman
function renderLaporan(data, summary) {
  const tbody = document.getElementById('laporanBody');
  tbody.innerHTML = '';
  
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted)">Tidak ada data laporan</td></tr>';
  } else {
    data.forEach(item => {
      const tr = document.createElement('tr');
      
      // Handle semua data dengan aman
      const tanggal = item.tanggal || '';
      const id_transaksi = item.id_transaksi || '';
      const kasir = item.kasir || '';
      const total = Number(item.total) || 0;
      const bayar = Number(item.bayar) || 0;
      const kembali = Number(item.kembali) || 0;
      const status = item.status || '';
      
      tr.innerHTML = `
        <td>${tanggal}</td>
        <td>${id_transaksi}</td>
        <td>${kasir}</td>
        <td>Rp${formatRupiah(total)}</td>
        <td>Rp${formatRupiah(bayar)}</td>
        <td>Rp${formatRupiah(kembali)}</td>
        <td><span style="color:${status === 'SUKSES' ? '#4caf50' : '#ff6b6b'}">${status}</span></td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  renderSummary(summary);
}  function renderSummary(summary) {
    const summaryContainer = document.getElementById('laporanSummary');
    if (!summary) {
      summaryContainer.innerHTML = '';
      return;
    }
    
    summaryContainer.innerHTML = `
      <div class="summary-card">
        <h3>Total Transaksi</h3>
        <div class="value">${summary.totalTransaksi || 0}</div>
      </div>
      <div class="summary-card">
        <h3>Total Pendapatan</h3>
        <div class="value">Rp${formatRupiah(summary.totalPendapatan || 0)}</div>
      </div>
      <div class="summary-card">
        <h3>Total Bayar</h3>
        <div class="value">Rp${formatRupiah(summary.totalBayar || 0)}</div>
      </div>
      <div class="summary-card">
        <h3>Total Kembali</h3>
        <div class="value">Rp${formatRupiah(summary.totalKembali || 0)}</div>
      </div>
    `;
  }

  function resetFilterLaporan() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('filterKasir').value = '';
  }

  function exportLaporanPDF() {
    const printContent = document.getElementById('tblLaporan').outerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = `
      <h2>Laporan Transaksi - ${kasirInfo.namaToko}</h2>
      <p>Tanggal: ${new Date().toLocaleDateString('id-ID')}</p>
      ${printContent}
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
    window.location.reload();
  }

  // ==================== SETTING FUNCTIONS ====================
  async function loadSetting() {
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getSetting' })
      });
      
      const data = await res.json();
      if (data && data.success) {
        currentSettings = data.data || {};
        renderSetting(currentSettings);
      }
    } catch (err) {
      console.error('Error loadSetting:', err);
    }
  }

  function renderSetting(settings) {
    document.getElementById('settingTheme').value = settings.Theme || 'dark';
    document.getElementById('settingAccentColor').value = settings.Warna_Aksen || '#14ffec';
    document.getElementById('settingAccentDark').value = settings.Warna_Aksen_Dark || '#0d7377';
    document.getElementById('settingAppName').value = settings.Nama_Aplikasi || 'KASIR WEB';
    document.getElementById('settingStrukFooter').value = settings.Footer_Struk || 'Terima Kasih';
    
    document.getElementById('accentPreview').style.backgroundColor = settings.Warna_Aksen || '#14ffec';
    document.getElementById('accentDarkPreview').style.backgroundColor = settings.Warna_Aksen_Dark || '#0d7377';
  }

  async function saveSetting() {
    try {
      const settings = {
        Theme: document.getElementById('settingTheme').value,
        Warna_Aksen: document.getElementById('settingAccentColor').value,
        Warna_Aksen_Dark: document.getElementById('settingAccentDark').value,
        Nama_Aplikasi: document.getElementById('settingAppName').value,
        Footer_Struk: document.getElementById('settingStrukFooter').value
      };
      
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ 
          action: 'updateSetting',
          settings: settings
        })
      });
      
      const data = await res.json();
      if (data && data.success) {
        alert('Setting berhasil disimpan!');
        applyThemeSettings(settings);
      } else {
        alert('Gagal menyimpan setting');
      }
    } catch (err) {
      alert('Gagal menyimpan setting');
    }
  }

  function applyThemeSettings(settings) {
    document.documentElement.style.setProperty('--accent', settings.Warna_Aksen || '#14ffec');
    document.documentElement.style.setProperty('--accent-dark', settings.Warna_Aksen_Dark || '#0d7377');
    document.title = settings.Nama_Aplikasi || 'KASIR WEB';
  }

  function resetSetting() {
    const defaultSettings = {
      Theme: 'dark',
      Warna_Aksen: '#14ffec',
      Warna_Aksen_Dark: '#0d7377',
      Nama_Aplikasi: 'KASIR WEB',
      Footer_Struk: 'Terima Kasih'
    };
    renderSetting(defaultSettings);
  }

  // Setup event handlers
  document.addEventListener('DOMContentLoaded', () => {
    // Setup tab navigation
    setupTabNavigation();
    
    // Set default dates for laporan
    const today = new Date();
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(today.getDate() - 7);
    
    document.getElementById('startDate').value = formatDateForInput(oneWeekAgo);
    document.getElementById('endDate').value = formatDateForInput(today);

    // Login handler
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      document.getElementById('loginMessage').innerText = 'Memeriksa...';
      
      try {
        const res = await fetch(SCRIPT_URL, { 
          method: 'POST', 
          body: JSON.stringify({ action: 'login', username, password }) 
        });
        const data = await res.json();
        
        if (data && data.success) {
          kasirInfo = data;
          document.getElementById('namaToko').innerText = kasirInfo.namaToko || 'Aplikasi Kasir';
          document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
          document.getElementById('kasirPage').classList.add('active');
          await loadMenu();
          document.getElementById('loginMessage').innerText = '';
        } else {
          document.getElementById('loginMessage').innerText = 'Login gagal';
        }
      } catch(err) {
        document.getElementById('loginMessage').innerText = 'Gagal terhubung ke server';
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      kasirInfo = {}; 
      transaksi = []; 
      menuData = [];
      filteredMenu = [];
      currentPage = 1;
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('loginPage').classList.add('active');
    });

    // Menu search handlers
    document.getElementById('menuSearch').addEventListener('input', (e) => {
      const q = e.target.value || '';
      filterMenuByText(q);
    });

    document.getElementById('clearSearch').addEventListener('click', () => {
      document.getElementById('menuSearch').value = '';
      filterMenuByText('');
      document.getElementById('menuSearch').focus();
    });

    // Pagination handlers
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        goToPage(currentPage - 1);
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      const totalPages = Math.ceil(filteredMenu.length / ITEMS_PER_PAGE);
      if (currentPage < totalPages) {
        goToPage(currentPage + 1);
      }
    });

    // Cash input handler
    document.getElementById('cashInput').addEventListener('input', function(e) {
      let digits = (e.target.value + '').replace(/[^\d]/g, '');
      if (digits === '') {
        e.target.value = '0';
        document.getElementById('uangKembali').textContent = '0';
        return;
      }
      e.target.value = formatRupiah(digits);
      hitungKembali();
    });

    document.getElementById('cashInput').addEventListener('focus', function(e) {
      e.target.select();
    });

    // Transaksi selesai handler
    document.getElementById('btnSelesai').addEventListener('click', async () => {
      if (!transaksi.length) {
        alert('Belum ada pesanan');
        return;
      }
      
      const cashEl = document.getElementById('cashInput');
      const total = transaksi.reduce((s,it) => s + it.subtotal, 0);
      const bayar = parseNumberFromString(cashEl.value);
      
      if (bayar < total) {
        alert('Jumlah bayar tunai kurang dari total!');
        return;
      }
      
      const konfirmasi = confirm(`Total: Rp ${formatRupiah(total)}\nBayar: Rp ${formatRupiah(bayar)}\nKembali: Rp ${formatRupiah(bayar - total)}\n\nLanjutkan transaksi?`);
      
      if (!konfirmasi) return;
      
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'saveTransaksi',
            transaksi: transaksi,
            total: total,
            idToko: kasirInfo.idToko,
            kasir: kasirInfo.namaKasir || 'Kasir',
            bayar: bayar, 
            kembali: bayar - total
          })
        });
        
        const data = await res.json();
        if (data && data.success) {
          printStruk();
          
          setTimeout(() => {
            transaksi = [];
            renderTransaksi();
            cashEl.value = '0';
            document.getElementById('uangKembali').textContent = '0';
            alert('Transaksi berhasil disimpan!');
          }, 1000);
          
        } else {
          alert('Gagal simpan transaksi');
        }
      } catch(err) {
        alert('Gagal mengirim data ke server');
      }
    });

    // Laporan handlers
    document.getElementById('btnLoadLaporan').addEventListener('click', loadLaporan);
    document.getElementById('btnResetFilter').addEventListener('click', resetFilterLaporan);
    document.getElementById('btnExportLaporan').addEventListener('click', exportLaporanPDF);

    // Setting handlers
    document.getElementById('btnSaveSetting').addEventListener('click', saveSetting);
    document.getElementById('btnResetSetting').addEventListener('click', resetSetting);

    // Color preview handlers
    document.getElementById('settingAccentColor').addEventListener('input', function(e) {
      document.getElementById('accentPreview').style.backgroundColor = e.target.value;
    });
    
    document.getElementById('settingAccentDark').addEventListener('input', function(e) {
      document.getElementById('accentDarkPreview').style.backgroundColor = e.target.value;
    });

    // Enter key for login
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('loginBtn').click();
      }
    });

    // Auto load setting on page load
    loadSetting();
  });
</script>

</body>
</html>
